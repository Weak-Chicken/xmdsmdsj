# Authentication System Part 1

## Authentication System on Backend

---

### Goal

In this part, I'll try to build a fully functional authentication system on the backend part. It has the following requirements:

1. It will accept register.
2. It will accept login.
3. It will NOT protect user's password during they are transmitting at this stage.
4. It will distinguish different users and give them different rights. At this stage, a user can be either user, admin, superadmin.
5. Level "user" will have no special functions at this stage.
6. Level "admin" will have no special functions at this stage.
7. Level "superadmin" will have full control of the whole website.

---

### Steps
0. Before Working on this

> I have set the MySQL database. I created a schema called 'expressdb' and created a table under it named 'User'. Then I use 'uuid' as the primary key. I defined three columns, they are 'userName', 'pwd', 'userEmail'. Users will need them as their logging in credits. 
>
> Besides, I also defined 'userBio' and 'userLevel' for it. 'userBio' is used for an example for query users. At the same time, 'userLevel' is used to define which level the user should be.

1. Write SQL configs in Express.

> In the backend/ folder, make a dir called 'db'. And since we may change our db option, here we make a dir called 'sql' under 'db' dir. Now, we can put all our sql settings or configs for express in this dir.
>
> First, let's put our logging info in. Create a js file called sqlConfigs and export the sql configs from there.
>
> Here I run my database on 192.168.240.141 on port 3306. These are my configs:
>
> ```js
> module.exports = {  
>   mysql: {   
>     host: '192.168.240.141',     
>     user: 'root',   
>     password: 'password',  
>     database:'expressdb', 
>     port: 3306  
>   }
>  };
> ```
>
> Also notice that I have create a schema in SQL called 'expressdb'.

2. Write SQL query for express

> To let our backend: Express to send queries to the database, we need to write query operations for it. Here we'll use user as an example. Based on what I have defined in the database, here we write three methods for it:
>
> 1. Get user by id(uuid)
> 2. Get all users (To be clear, when you get users here, you can only get their name, uuid and bio. DO NOT get their password or email etc.)
> 3. Add / Insert one user to the database
>
> With these three opertaions, we should be able to write log in / out operation and register opertaion.
>
> Now, we create a js file named 'userSqlOp.js'(User SQL Opertions) under db/sql/ dir. In the file we put these code:
>
> ```js
> var UserSQL = {  
>   insert:'INSERT INTO User(uuid,userName,pwd,userEmail,userBio,userLevel) VALUES(?,?,?,?,?,?)', 
>   queryAll:'SELECT * FROM User',  
>   getUserById:'SELECT * FROM User WHERE uuid = ? ',
> };
> 
> module.exports = UserSQL;
> ```


3. Write log in method in Express

> Now our express is ready to operate our database. We can now write our log in method in our backend.
> Now we need to create user APIs. Find the 'router' folder under express root folder, create a dir called 'apis', and under it, create another dir called 'v1'. This would be helpful when you later manage your apis acrossing different versions. 
>
> First, under the 'v1' dir, create a js file called 'User.js' to store all APIs in /User/ .
>
> Then, in this file, we need to import our libraries. Use these code to import libs.
>
> ```js
> // Use express module
> var express = require('express');
> var router = express.Router();
>
> // Use SQL modules with our configs
> var mysql = require('mysql');
> var mysqlConfig = require('../../../db/sql/sqlConfigs');
> var mysqlUserOp = require('../../../db/sql/userSqlOp');
>
> // Build a connection pool for sql connection
> var mysqlPool = mysql.createPool(mysqlConfig.mysql);
> ```
>
> First try to get info from req.body. However I got null value from it. Then from [This Blog](https://blog.csdn.net/TyrionJ/article/details/81990048) I think it might be body-parser reason. However it is not. I did import body-parser based on the blog, but my server cannot run. It will not respond to any request once body-parser is on. After I searched many blogs, there is no reason. Finally, I found the Express [offical document](http://www.expressjs.com.cn/4x/api.html) which explains that 
>```js
> app.use(express.json());
> app.use(express.urlencoded({ extended: true }));
>```
> has replaced the original body-parser statements (Which are mentioned in the blog):
>
> ```js
> app.use(bodyPaser.json)
> app.use(bodyParser.urlencoded({ extended: false})) 
> ```
>
> Therefore, using body-parser is a wrong way.
>
> However, my problem is still there and I cannot receive any data from client post body. Then I realized that our server is accepting x-www-form-urlencoded data not form-data I sent in Postman. So I changed it and everything works fine.
>
> <img alt="Postman-formdata" src="../img/3/postman-formdata.png">
> <div align=center>Using form-data</div>
> <img alt="Postman-x-www-form-urlencoded-data" src="../img/3/postman-x-www-form-urlencoded-data.png">
> <div align=center>Using x-www-form-urlencoded-data</div>

>
>
>
> After that, we now can create our log in api. The following code build a log in API for us and listening to /User/Login/
>
> ```js
>
> ```
>
> 

4. Let Express deal with sessions and cookies

> Log in but not remeber will be a problem. So we need to know the user has logged in on our site.
> Install cookie-parser and express-session